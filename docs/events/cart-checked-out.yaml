# Integration Event Schema: CartCheckedOut
#
# This document describes the CartCheckedOut integration event published by the Cart bounded context
# and consumed by other contexts (Product, Order, Analytics).

event:
  name: CartCheckedOut
  type: integration
  version: 1

  description: >
    Published when a customer completes checkout of their shopping cart.
    Signals that the cart is finalized and other contexts should react
    (e.g., reduce stock, create order, track analytics).

  publisher:
    context: Cart
    package: de.sample.aiarchitecture.cart.domain.event
    class: CartCheckedOut

  subscribers:
    - context: Product
      handler: ProductStockEventListener
      action: Reduce product stock quantities
      acl: CartEventTranslator

    - context: Order
      handler: OrderCreationListener (future)
      action: Create order from cart items
      acl: CartEventTranslator (future)

    - context: Analytics
      handler: CheckoutAnalyticsListener (future)
      action: Track checkout metrics
      acl: CartEventTranslator (future)

  characteristics:
    - Immutable (Java record)
    - Named in past tense (CartCheckedOut)
    - Published after successful cart save
    - Versioned for evolution
    - Uses DTOs (not domain objects)

schema:
  version_1:
    fields:
      eventId:
        type: UUID
        description: Unique identifier for this event instance
        required: true
        example: "123e4567-e89b-12d3-a456-426614174000"

      cartId:
        type: CartId (Value Object)
        description: Identity of the checked-out cart
        required: true
        example: { value: "cart-550e8400-e29b-41d4-a716-446655440000" }

      customerId:
        type: CustomerId (Value Object)
        description: Identity of the customer who checked out
        required: true
        example: { value: "customer-123e4567-e89b-12d3-a456-426614174001" }

      totalAmount:
        type: Money (Value Object)
        description: Total checkout amount
        required: true
        fields:
          amount: BigDecimal
          currency: String (ISO 4217 code)
        example: { amount: 99.99, currency: "EUR" }

      itemCount:
        type: int
        description: Total number of items in the cart
        required: true
        example: 3

      items:
        type: List<ItemInfo>
        description: List of items in the cart (lightweight DTOs)
        required: true
        fields:
          - productId:
              type: ProductId (Value Object from Shared Kernel)
              description: Identity of the product
              required: true
              example: { value: "550e8400-e29b-41d4-a716-446655440000" }

          - quantity:
              type: int
              description: Quantity of this product
              required: true
              constraints: Must be positive (> 0)
              example: 2

        example:
          - productId: { value: "550e8400-e29b-41d4-a716-446655440000" }
            quantity: 2
          - productId: { value: "550e8400-e29b-41d4-a716-446655440001" }
            quantity: 1

      occurredOn:
        type: Instant
        description: Timestamp when the event occurred
        required: true
        example: "2025-11-08T10:15:30.123456Z"

      version:
        type: int
        description: Event schema version
        required: true
        value: 1

  version_2_future:
    status: Planned (not yet implemented)

    additional_fields:
      warehouseId:
        type: WarehouseId (Value Object)
        description: Warehouse allocation for this order
        required: false
        example: { value: "warehouse-eu-west-1" }

      reservationId:
        type: ReservationId (Value Object)
        description: Stock reservation ID for optimistic locking
        required: false
        example: { value: "reservation-123e4567-e89b-12d3-a456-426614174002" }

    enhanced_item_fields:
      items:
        additional_fields:
          batchNumber:
            type: String
            description: Inventory batch number
            required: false
            example: "BATCH-2025-11-001"

          warehouseLocation:
            type: String
            description: Warehouse location code
            required: false
            example: "A-12-34"

    backward_compatibility: >
      Version 2 maintains backward compatibility with version 1 by making
      all new fields optional. Consumers using ACL can handle both versions.

example_payload_v1:
  eventId: "123e4567-e89b-12d3-a456-426614174000"
  cartId:
    value: "cart-550e8400-e29b-41d4-a716-446655440000"
  customerId:
    value: "customer-123e4567-e89b-12d3-a456-426614174001"
  totalAmount:
    amount: 99.99
    currency: "EUR"
  itemCount: 2
  items:
    - productId:
        value: "550e8400-e29b-41d4-a716-446655440000"
      quantity: 2
    - productId:
        value: "550e8400-e29b-41d4-a716-446655440001"
      quantity: 1
  occurredOn: "2025-11-08T10:15:30.123456Z"
  version: 1

usage_guidelines:

  for_publishers:
    - "Publish only after successful cart persistence (transactional)"
    - "Use CartCheckedOut.now() factory method"
    - "Include all required fields"
    - "Use lightweight DTOs, not full domain objects"
    - "Increment version on schema changes"

  for_consumers:
    - "Use Anti-Corruption Layer to translate events"
    - "Handle version differences in ACL"
    - "Don't directly couple to event structure"
    - "Implement idempotency (same eventId = same result)"
    - "Handle failures gracefully (compensation)"

anti_corruption_layer:
  purpose: >
    Protects consuming contexts from changes in Cart's event schema.
    Translates Cart's ubiquitous language into consumer's language.

  implementation:
    class: de.sample.aiarchitecture.product.adapter.incoming.event.acl.CartEventTranslator
    method: translate(CartCheckedOut event)
    returns: List<ReduceProductStockCommand>

  version_handling:
    - "ACL contains version-specific translation methods"
    - "translateV1() handles version 1 events"
    - "translateV2() handles version 2 events (future)"
    - "Throws UnsupportedEventVersionException for unknown versions"

versioning_strategy:

  current_version: 1

  evolution_rules:
    - "New fields must be optional (nullable)"
    - "Existing fields cannot be removed"
    - "Field types cannot change"
    - "Version number increments on schema change"
    - "ACL must support all active versions"

  deprecation_policy:
    - "Support last 2 versions simultaneously"
    - "Deprecate old versions after 6 months"
    - "Coordinate version upgrades with all consumers"

testing:

  integration_tests:
    - "Test event publishing after cart checkout"
    - "Verify ProductStockEventListener receives event"
    - "Verify stock reduction via ACL"
    - "Test version handling in ACL"

  contract_tests:
    - "Verify event schema matches documentation"
    - "Test backward compatibility (v1 consumers with v2 events)"
    - "Validate required fields are present"

  acl_tests:
    - "Test translateV1() with valid event"
    - "Test translateV2() with future event"
    - "Test UnsupportedEventVersionException for unknown versions"

production_considerations:

  idempotency:
    - "Use eventId to deduplicate"
    - "Store processed event IDs"
    - "Handle duplicate events gracefully"

  error_handling:
    - "Log unprocessable events"
    - "Publish compensation events on failure"
    - "Alert DevOps on version mismatches"

  monitoring:
    - "Track event publish rate"
    - "Monitor processing latency"
    - "Alert on event processing failures"
    - "Dashboard for version distribution"

references:
  - "Eric Evans' Domain-Driven Design (2003)"
  - "Vaughn Vernon's Implementing Domain-Driven Design (2013), Chapter 13"
  - "Martin Fowler's Event-Driven Architecture patterns"
  - "Chris Richardson's Microservices Patterns (2018)"

changelog:
  - version: 1
    date: "2025-11-08"
    author: "Cart Team"
    changes:
      - "Initial version"
      - "Basic checkout event with items"

  - version: 2
    date: "TBD"
    author: "Cart Team"
    status: "Planned"
    changes:
      - "Add warehouse allocation"
      - "Add batch numbers for inventory"
      - "Add reservation IDs"
