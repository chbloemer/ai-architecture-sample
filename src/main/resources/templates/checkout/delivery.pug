extends ../layout

block content
  .checkout
    .checkout__progress(data-test="checkout-progress")
      .checkout__step.checkout__step--completed Buyer Info
      .checkout__step.checkout__step--active Delivery
      .checkout__step Payment
      .checkout__step Review

    if error
      .alert.alert--error(data-test="delivery-error-message")= error

    form.checkout__form(method="post" action="/checkout/delivery" data-test="delivery-form")
      h3.checkout__section-title Shipping Address

      .form__group
        label.form__label(for="street") Street Address
        input.form__input#street(type="text" name="street" required placeholder="123 Main Street" value=(deliveryPage.existingAddress() ? deliveryPage.existingAddress().street() : '') data-test="delivery-street-input")

      .form__group
        label.form__label(for="streetLine2") Address Line 2 (Optional)
        input.form__input#streetLine2(type="text" name="streetLine2" placeholder="Apt, Suite, Unit, etc." value=(deliveryPage.existingAddress() ? deliveryPage.existingAddress().streetLine2() : '') data-test="delivery-street2-input")

      .form__row
        .form__group
          label.form__label(for="city") City
          input.form__input#city(type="text" name="city" required placeholder="City" value=(deliveryPage.existingAddress() ? deliveryPage.existingAddress().city() : '') data-test="delivery-city-input")

        .form__group
          label.form__label(for="state") State/Province (Optional)
          input.form__input#state(type="text" name="state" placeholder="State" value=(deliveryPage.existingAddress() ? deliveryPage.existingAddress().state() : '') data-test="delivery-state-input")

      .form__row
        .form__group
          label.form__label(for="postalCode") Postal Code
          input.form__input#postalCode(type="text" name="postalCode" required placeholder="12345" value=(deliveryPage.existingAddress() ? deliveryPage.existingAddress().postalCode() : '') data-test="delivery-postalcode-input")

        .form__group
          label.form__label(for="country") Country
          input.form__input#country(type="text" name="country" required placeholder="Country" value=(deliveryPage.existingAddress() ? deliveryPage.existingAddress().country() : '') data-test="delivery-country-input")

      h3.checkout__section-title Shipping Method

      .shipping-options(data-test="delivery-shipping-options")
        each option in shippingOptions
          - var isSelected = deliveryPage.existingShippingOptionId() && deliveryPage.existingShippingOptionId() === option.id()
          label.option-card(class=isSelected ? 'option-card--selected' : '' data-test="delivery-shipping-option")
            input.option-card__radio(type="radio" name="shippingOptionId" value=option.id() required checked=isSelected data-test="delivery-shipping-radio")
            input(type="hidden" name="shippingOptionName" value=option.name() disabled=!isSelected)
            input(type="hidden" name="estimatedDelivery" value=option.estimatedDelivery() disabled=!isSelected)
            input(type="hidden" name="shippingCost" value=option.cost() disabled=!isSelected)
            input(type="hidden" name="currencyCode" value=option.currencyCode() disabled=!isSelected)
            .option-card__content
              span.option-card__label #{option.name()}
              span.option-card__description #{option.estimatedDelivery()}
              span.option-card__price #{option.cost()} #{option.currencyCode()}

      .form__actions
        a.btn.btn--secondary(href="/checkout/buyer" data-test="delivery-back-link") Back
        button.btn.btn--primary(type="submit" data-test="delivery-continue-button") Continue to Payment

    if deliveryPage.lineItems() && deliveryPage.lineItems().size() > 0
      .order-summary
        h3.order-summary__title Order Summary
        each item in deliveryPage.lineItems()
          .order-summary__item
            .order-summary__item-image
              if item.imageUrl()
                img(src=item.imageUrl() alt=item.productName())
            span.order-summary__item-name #{item.productName()}
            span.order-summary__item-qty x#{item.quantity()}
            span.order-summary__item-price #{item.lineTotal()} #{item.currencyCode()}

        if deliveryPage.totals()
          .order-summary__total
            span Subtotal
            span #{deliveryPage.totals().subtotal()} #{deliveryPage.totals().currencyCode()}

  script.
    document.querySelectorAll('.option-card input[type="radio"]').forEach(function(radio) {
      radio.addEventListener('change', function() {
        document.querySelectorAll('.option-card input[type="hidden"]').forEach(function(hidden) {
          hidden.disabled = true;
        });
        var selectedOption = this.closest('.option-card');
        selectedOption.querySelectorAll('input[type="hidden"]').forEach(function(hidden) {
          hidden.disabled = false;
        });
        document.querySelectorAll('.option-card').forEach(function(opt) {
          opt.classList.remove('option-card--selected');
        });
        selectedOption.classList.add('option-card--selected');
      });
    });
