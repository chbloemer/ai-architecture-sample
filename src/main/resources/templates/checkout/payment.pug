extends ../layout

block content
  .checkout
    .checkout__progress(data-test="checkout-progress")
      .checkout__step.checkout__step--completed Buyer Info
      .checkout__step.checkout__step--completed Delivery
      .checkout__step.checkout__step--active Payment
      .checkout__step Review

    if error
      .alert.alert--error(data-test="payment-error-message")= error

    form.checkout__form(method="post" action="/checkout/payment" data-test="payment-form")
      h3.checkout__section-title Select Payment Method

      .payment-options(data-test="payment-options")
        each provider in paymentProviders
          if provider.available()
            - var isSelected = paymentPage.existingPaymentProviderId() && paymentPage.existingPaymentProviderId() === provider.id()
            label.option-card(class=isSelected ? 'option-card--selected' : '' data-test="payment-provider-option")
              input.option-card__radio(type="radio" name="providerId" value=provider.id() required checked=isSelected data-test="payment-provider-radio")
              .option-card__content
                span.option-card__label #{provider.displayName()}
                if !provider.available()
                  span.option-card__unavailable (Unavailable)

      .form__group
        label.form__label(for="providerReference") Payment Reference (Optional)
        input.form__input#providerReference(type="text" name="providerReference" placeholder="e.g., Payment Intent ID" value='')

      .form__actions
        a.btn.btn--secondary(href="/checkout/delivery" data-test="payment-back-link") Back
        button.btn.btn--primary(type="submit" data-test="payment-continue-button") Continue to Review

    if paymentPage.lineItems() && paymentPage.lineItems().size() > 0
      .order-summary
        h3.order-summary__title Order Summary
        each item in paymentPage.lineItems()
          .order-summary__item
            .order-summary__item-image
              if item.imageUrl()
                img(src=item.imageUrl() alt=item.productName())
            span.order-summary__item-name #{item.productName()}
            span.order-summary__item-qty x#{item.quantity()}
            span.order-summary__item-price #{item.lineTotal()} #{item.currencyCode()}

        if paymentPage.totals()
          .order-summary__line
            span Subtotal
            span #{paymentPage.totals().subtotal()} #{paymentPage.totals().currencyCode()}
          if paymentPage.totals().shipping()
            .order-summary__line
              span Shipping
              span #{paymentPage.totals().shipping()} #{paymentPage.totals().currencyCode()}
          .order-summary__total
            span Total
            span #{paymentPage.totals().total()} #{paymentPage.totals().currencyCode()}

  script.
    document.querySelectorAll('.option-card input[type="radio"]').forEach(function(radio) {
      radio.addEventListener('change', function() {
        document.querySelectorAll('.option-card').forEach(function(opt) {
          opt.classList.remove('option-card--selected');
        });
        this.closest('.option-card').classList.add('option-card--selected');
      });
    });
